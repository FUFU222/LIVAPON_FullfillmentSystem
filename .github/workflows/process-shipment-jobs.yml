name: Process Shipment Jobs

on:
  schedule:
    # 間隔はここで調整（例：10分おき）
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      limit:
        description: 'Override shipment job batch size (1-50)'
        required: false
        default: '20'

jobs:
  run-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    env:
      APP_BASE_URL: ${{ vars.APP_BASE_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET || vars.CRON_SECRET }}
      JOB_LIMIT: ${{ github.event.inputs.limit || vars.SHIPMENT_JOB_LIMIT || '20' }}
    steps:
      - name: Trigger shipment job worker
        run: |
          set -euo pipefail

          if [ -z "${APP_BASE_URL:-}" ]; then
            echo "::error::APP_BASE_URL repository variable is not configured"
            exit 1
          fi

          if [ -z "${CRON_SECRET:-}" ]; then
            echo "::error::CRON_SECRET secret is not configured"
            exit 1
          fi

          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update >/dev/null
            sudo apt-get install -y jq >/dev/null
          fi

          RESPONSE_FILE=$(mktemp)
          HTTP_STATUS=$(curl -sS --show-error --retry 5 --retry-all-errors --retry-delay 5 \
            --max-time 20 --connect-timeout 5 \
            -w "%{http_code}" -o "${RESPONSE_FILE}" \
            -X POST \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            "${APP_BASE_URL}/api/internal/shipment-jobs/process?limit=${JOB_LIMIT}")

          BODY=$(cat "${RESPONSE_FILE}")
          echo "Shipment job worker response (${HTTP_STATUS}): ${BODY}"

          if [ "${HTTP_STATUS}" -ge 400 ]; then
            exit 1
          fi

          OK=$(jq -r '.ok // empty' "${RESPONSE_FILE}" 2>/dev/null || true)
          if [ "${OK}" != "true" ]; then
            echo "::error::Shipment job worker did not return ok=true"
            exit 1
          fi

          CLAIMED=$(jq -r '.summary.claimed // ""' "${RESPONSE_FILE}" 2>/dev/null || echo "")
          SUCCEEDED=$(jq -r '.summary.succeeded // ""' "${RESPONSE_FILE}" 2>/dev/null || echo "")
          FAILED=$(jq -r '.summary.failed // ""' "${RESPONSE_FILE}" 2>/dev/null || echo "")

          {
            echo "### Shipment Job Worker"
            echo "- HTTP status: ${HTTP_STATUS}"
            echo "- Batch limit: ${JOB_LIMIT}"
            if [ -n "${CLAIMED}" ]; then
              echo "- Claimed: ${CLAIMED}, Succeeded: ${SUCCEEDED}, Failed: ${FAILED}"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
