# 配送状態分離 方針メモ

最終更新: 2026-02-20

## 1. 目的
- ユーザー体験を「受付前 / 受付後」の2軸に限定し、内部同期状態を露出しない。
- Shopify 連携遅延・失敗があっても、ユーザー画面の挙動を安定させる。
- 内部エラーは管理者通知（田中アドレス）と運用監視で吸収する。

## 2. 確定要件（ユーザー要望）
1. ユーザー画面には `連携中` / `エラー` を表示しない。
2. ユーザー向けトースト・モーダル・補足テキストは「受付できたかどうか」のみ表示する。
3. 連携遅延・連携エラーは管理者側で検知し、管理者メールへ通知する。
4. 状態変更に伴う改修で、既存の配送整合性（DB / Shopify / UI）を崩さない。

## 3. 現状の課題（技術）
1. `/api/shipment-jobs/[id]` が「状態取得」と「実処理」を兼務している。
2. `orderLimit: 1` 固定により、注文数増加時に反映時間が直線的に増える。
3. フロントのポーリング間隔が長く、体感遅延が大きい。
4. 一部UIが内部状態を示す構造になっている。

## 4. 設計方針（変更耐性重視）
### 4.1 状態の責務分離
- ユーザー表示状態: ローカル出荷確定ベース（未発送 / 一部発送済 / 発送済）。
- 内部同期状態: `shipments.sync_status` で管理（ユーザー非表示）。
- 運用状態: ログ + 管理者メールで監視。

### 4.2 処理の責務分離
- ユーザー操作: 受付登録（ジョブ投入 + ローカル確定）を高速返却。
- バックグラウンド: Shopify 同期・再試行をワーカーで継続実行。
- 回復処理: resync ワーカーが pending/error を吸収。

### 4.3 UIポリシー
- ユーザー側は内部挙動を説明しない。
- 文言は「受付前 / 受付後」に収束させる。
- 失敗詳細は管理者経路にのみ出す。

## 5. 変更範囲（安全な最小単位）
## 5.1 フロント
- `components/orders/orders-dispatch-panel.tsx`
  - 内部処理詳細の表示を段階的に縮小。
  - ポーリングは重複リクエスト防止を入れて短縮可能にする。
- `components/orders/orders-dispatch-table.tsx`
  - バッジ判定はローカル進捗優先を維持。

## 5.2 API / ワーカー
- `app/api/shipment-jobs/[id]/route.ts`
  - `orderLimit` を固定値から設定値へ移行。
- `app/api/shopify/orders/shipments/route.ts`
  - kickoff 処理の上限を設定値で調整可能にする。
- `lib/jobs/shipment-import-runner.ts`
  - ローカル確定済みの扱いを維持し、同期遅延を非致命扱いで処理継続。

## 5.3 通知
- 新規通知モジュール追加（例: `lib/notifications/shipment-sync-alert.ts`）。
- 送信先は管理者メール（例: `a.tanaka@chairman.jp`）を環境変数で管理。
- トリガー:
  1. Shopify 同期が `error` で確定した時
  2. `pending` が閾値時間を超えて滞留した時

## 5.4 運用ジョブ
- `app/api/internal/shipments/resync/route.ts`
  - 失敗サマリの通知フックを追加。
- `.github/workflows/resync-pending-shipments.yml`
  - 実行間隔は段階的に短縮（最終値は別途確定）。

## 6. ガードレール（壊さないための条件）
1. DBスキーマは破壊的変更を避け、既存列を利用して拡張する。
2. `orderLimit` / `pollInterval` はコード直書きせず設定値化する。
3. 失敗時は「ユーザー表示を戻す」ではなく「管理者通知 + 再試行」で吸収する。
4. 変更は段階導入し、各段階でテストとビルドを必須とする。

## 7. 段階導入プラン
1. **Phase A (低リスク)**
   - `orderLimit` の設定化（初期値は保守的）。
   - ポーリング重複防止。
2. **Phase B (UX方針反映)**
   - ユーザー向け文言・UIから内部状態文言を削除。
   - 受付前/受付後に集中した表示へ統一。
3. **Phase C (運用強化)**
   - 管理者メール通知の実装。
   - 遅延・失敗の通知条件を運用チューニング。

## 8. 受け入れ基準
1. ユーザー画面で内部同期状態（連携中/エラー）が表示されない。
2. 受付後の表示は一貫して「受付後」側に遷移する。
3. Shopify 連携失敗時は管理者通知が送信される。
4. `npm test` と `npm run build` が通る。

## 9. 保留事項
1. `orderLimit` の最終値（3 or 5）。
2. ポーリング最終値（3秒 or 2秒）。
3. resync ワーカーの最終実行間隔（2分 or 5分）。

