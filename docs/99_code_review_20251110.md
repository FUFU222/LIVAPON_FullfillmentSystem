# Code Review – LIVAPON 配送管理コンソール (2025-11-10)

## Findings (highest severity first)
1. **Orders data/service is a 1.1K-line god object**  
   - Location: `lib/data/orders.ts:1-1010`.  
   - Impact: Order querying, shipment creation, fulfillment-order sync, cancellation logging, demo fixtures, and admin helpers all live in one module with shared mutable helpers. Any change risks cascading regressions (e.g., FO sync touching shipment logic) and makes unit testing almost impossible.  
   - Recommendation: Split by responsibility (e.g., `orders/queries.ts`, `shipments/mutations.ts`, `fulfillment/sync.ts`, demo fixtures) and ensure each exports narrow functions so future features don’t add more conditionals here.

2. **React `cache()` memoization makes vendor data permanently stale**  
   - Location: `lib/data/orders.ts:520-631`.  
   - Impact: `getOrders`, `getOrderDetail`, and `getOrderDetailForAdmin` are wrapped in `cache()`, which memoizes results across requests. After the first fetch, `/orders` will never see updated Supabase data until the process restarts, so the realtime refresh banner cannot actually reload shipments.  
   - Recommendation: Drop `cache()` or replace it with `unstable_cache` + revalidation tags keyed per vendor/order so `router.refresh()` and background resyncs can invalidate correctly.

3. **Shipment API re‑implements business rules already handled in `upsertShipment`**  
   - Location: `app/api/shopify/orders/shipments/route.ts:20-137` vs. `lib/data/orders.ts:633-775`.  
   - Impact: The API route re-queries `line_items`, rebuilds quantity validation, and then calls `upsertShipment`, which repeats the same checks and Supabase reads. Any future rule (e.g., FO line-item IDs) must be updated in two places.  
   - Recommendation: Move the “group by order + clamp quantity” logic into a shared helper inside the data layer, or let the API call a single `createShipmentsForOrder` action that encapsulates validation and persistence once.

4. **Silent fallback to fake `demoOrders` hides Supabase misconfiguration**  
   - Location: `lib/data/orders.ts:525-575` & `601-606`.  
   - Impact: If `SUPABASE_SERVICE_ROLE_KEY` is missing in any environment, vendors still see hard-coded demo data with no errors, so real operations could run against empty or outdated views without anyone noticing.  
   - Recommendation: Fail fast (throw) whenever the service client cannot be created outside local storybook/dev modes, or guard the fallback behind an explicit `USE_DEMO_DATA` flag so staging/prod never mask infra issues.

5. **Unauthenticated debug page exposes vendor table**  
   - Location: `pages/test-supabase.tsx:1-41`.  
   - Impact: This legacy Pages Router route bypasses the authenticated App Shell and lets any visitor query `vendors` through the anon key. Even with RLS, it leaks schema details and keeps the `/pages` directory alive.  
   - Recommendation: Remove the route or wrap it in admin-only feature flags before the next deploy.

6. **Shopify API version is hard-coded in multiple places**  
   - Location: `app/api/shopify/orders/ingest/route.ts:41-48`, `lib/shopify/fulfillment.ts:5-6`, `lib/data/fulfillment-requests.ts:10`, plus tests and config.  
   - Impact: When migrating API versions, forgetting to edit any one of these literals will cause webhook 400s or mismatched GraphQL endpoints.  
   - Recommendation: Define a single `SHOPIFY_API_VERSION` constant (env + fallback) and reuse it everywhere, including header validation.

7. **Service-role Supabase client is re-instantiated in multiple modules**  
   - Location: `lib/data/vendors.ts:1-15` and `lib/data/imports.ts:1-27` instead of reusing `lib/shopify/service-client.ts`.  
   - Impact: Duplicating client creation scatters env validation logic and loses the memoization already implemented in `getShopifyServiceClient()`, making configuration drift more likely.  
   - Recommendation: Export a shared `getServiceClient` factory and import it everywhere that needs service-role access.

8. **`SelectedLineItem` type duplicated across components**  
   - Location: `components/orders/orders-dispatch-table.tsx:44-55` and `components/orders/orders-dispatch-panel.tsx:21-32`.  
   - Impact: The two definitions must stay in sync manually; adding a field (e.g., vendor code) in one file causes runtime bugs in the other.  
   - Recommendation: Co-locate the type in `components/orders/types.ts` (or extend `OrderLineItemSummary`) and import it from both components.

9. **Critical flows lack regression tests**  
   - Location: `__tests__/` only contains `shopify-*.test.ts` webhook/HMAC cases; nothing exercises shipment creation, Realtime UX, or vendor profile actions.  
   - Impact: The most complex modules (`lib/data/orders.ts`, `/api/shopify/orders/shipments`, vendor profile actions) can regress with no automated signal, which encourages more defensive duplication.  
   - Recommendation: Add unit tests around shipment mutations/FO sync and component tests for the dispatch table selection logic.

## Open Questions
- Is the `demoOrders` fallback still needed outside design reviews, or can we drop it once Supabase is mandatory?
- Should we keep any equivalent of `pages/test-supabase.tsx` for troubleshooting via MCP/CLI, or can all diagnostics move to scripts/tests?

## Suggested Next Steps
1. Remove `cache()` usage from order loaders and introduce proper revalidation so realtime refresh works.  
2. Break `lib/data/orders.ts` into dedicated modules and expose a single shipment creation API that `/api/shopify/orders/shipments` can call without duplicating validation.  
3. Delete or guard `pages/test-supabase.tsx`, then consolidate service-role client creation and centralize the Shopify API version constant.  
4. Backfill tests for shipment creation/cancellation and dispatch selection logic before adding the realtime UX enhancements listed in docs/97.

## Tests
- Not run (review only).
