# Codex 開発指針プロンプト（2025-11-13）

> LIVAPON Fulfillment System / 永続性・可用性重視モード

## 🎯 基本方針
- **動かすより壊れない**
- **修正するより再発させない**
- **現在の要件より未来の変更に耐える構造**

## 🧩 実装方針
1. **応急処置禁止**: 根因を特定し、同種の問題が二度と起きない構造へ置換。`dedupe` や `try/catch` は最終防壁のみ。
2. **変更に強い設計**: 単一責務・拡張容易な抽象化。1箇所触って3箇所壊れる設計を排除。
3. **調査→実装**: Shopify/Next.js/Vercel の公式情報や OSS を参照し「なぜ」の根拠をコメントに残す。
4. **運用考慮**: 環境変数や Vercel 設定依存をコメントで明示。「変更時は再デプロイ必須」など運用メモを残す。
5. **UI/UX・API整合**: 誰が・いつ・何を・なぜ操作するかを明瞭に。副作用失敗でも主要処理は巻き戻さない。

## 🧮 レビュー観点
|評価軸|質問|基準|
|---|---|---|
|可用性|将来の仕様変更に耐えるか|再デプロイ無しで壊れない|
|設計妥当性|単一責務か|一関数一責務|
|運用考慮|設定変更時の挙動を明記したか|運用で詰まらない|
|観測可能性|失敗原因がすぐ特定できるか|1分で原因追跡|
|UX合理性|ユーザーが迷わないか|操作が想定どおり|

## ✅ 出力ルール
- 短期修正案と長期最適案を必ず提示。
- 修正後のログ/監視や計測ポイントを提案。
- リスクと防止策をセットで提示。
- 「なぜそうしたか」をコメントや docstring に記す。

## 🚦 再設計トリガー
- 同一ID重複（lineItems 3件等）
- Webhook 401/408 再発
- 非同期リトライの二重発火
- UI/DB不整合
- 同領域に3回以上の修正（構造疲労）

## 🧾 出力テンプレ（例）
```
⚙️ 問題: lineItems が重複して UI に 3 件表示。
🔍 根因: order/fulfillment マッピングの責務境界が曖昧。
🩹 短期対応: dedupeOrderLineItems で表示崩れ防止。
🧱 長期対応: order 組成時に一意性制約。変換層を一方向化。
🔁 再発防止: Transformer 層に assertUnique 追加。ログで検知。
🧭 備考: 複数倉庫対応にも拡張可能。
```

> モットー: **「一度の修正で二度と悩まない」**

